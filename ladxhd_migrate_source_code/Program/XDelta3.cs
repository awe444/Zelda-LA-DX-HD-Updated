using System.Collections.Generic;
using System.Diagnostics;
using System.IO;

namespace LADXHD_Migrater
{
    internal class XDelta3
    {
        private static string Exe;
        private static string Args;

        private static Dictionary<string, object> resources = ResourceHelper.GetAllResources();

        public enum Operation { Create, Apply }

        public static void Initialize()
        {
            XDelta3.Exe = Config.baseFolder + "\\ladxhd_game_source_code\\xdelta3.exe";
        }

        private static string GetCreateArguments(string OldFile, string NewFile, string PatchFile)
        {
		    string args = string.Empty;
		    args = string.Concat(new string[]
		    {
			    args,
			    " -f -s \"",
			    OldFile,
			    "\" \"",
			    NewFile,
			    "\" \"",
			    PatchFile,
			    "\""
		    });
            return args;
        }

        private static string GetApplyArguments(string OldFile, string PatchFile, string NewFile)
        {
		    string args = string.Empty;
		    args = string.Concat(new string[]
		    {
			    args,
			    " -d -f -s \"",
			    OldFile,
			    "\" \"",
			    PatchFile,
			    "\" \"",
			    NewFile,
			    "\""
		    });
            return args;
        }

        private static void Start()
        {
            Process xDelta = new Process();
            ProcessStartInfo startInfo = new ProcessStartInfo 
            {
                WorkingDirectory = Config.baseFolder,
                FileName = XDelta3.Exe,
                Arguments = XDelta3.Args,
                UseShellExecute = false,
                CreateNoWindow = true,
                RedirectStandardError = true,
                WindowStyle = ProcessWindowStyle.Normal
            };
            xDelta.StartInfo = startInfo;
            xDelta.Start();
            xDelta.WaitForExit();
        }

        public static void Execute(Operation action, string input, string diff, string output, string target = "")
        {
            if (action == Operation.Apply)
                XDelta3.Args = XDelta3.GetApplyArguments(input, diff, output);
            else if (action == Operation.Create)
                XDelta3.Args = XDelta3.GetCreateArguments(input, diff, output);
            XDelta3.Start();

            if (!string.IsNullOrEmpty(target))
                output.MovePath(target, true);
        }

        public static void Create()
        {
            File.WriteAllBytes(XDelta3.Exe, (byte[])resources["xdelta3.exe"]);
        }

        public static void Remove()
        {
            XDelta3.Exe.RemovePath();
        }
    }
}
